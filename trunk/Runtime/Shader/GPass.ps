
#include "GlobalInput.sh"
#include "GlobalPSConstant.sh"


//--------------------------------------------------------------------------------------
// Pixel Shader
//--------------------------------------------------------------------------------------
float4 PS( PsIn In) : SV_Target
{
	float3 diffuse = txDiffuse.Sample( samLinear, In.Tex).rgb;
	float3 lightColor = 0;
	
#ifdef _BUMP
    float3 bump = 1.5f * ( txNormal.Sample( samLinear, In.Tex).rgb - float3(0.5,0.5,0.5) );
	In.ViewNormal = In.ViewNormal + bump.x*In.ViewTangent + bump.y*In.ViewBinormal;
    In.ViewNormal = normalize(In.ViewNormal);
#endif

#ifdef _LIGHT
	const float _INTERTHRESHOLD = 1.0f;

	float3 PointLightVec = In.lightViewPos - In.ViewPos;
	float3 PointLightDir = length(PointLightVec) < _INTERTHRESHOLD ? PointLightVec : normalize(PointLightVec);

	float3 PointLightColor = In.lightColor * saturate(dot(In.ViewNormal, PointLightDir));
	lightColor += PointLightColor;

	float NL = saturate( dot(In.ViewNormal, PointLightDir) ); 
#else
	float NL = saturate( dot(In.ViewNormal, g_SunDirection) ); 
#endif


	float3 finalColor = diffuse * ( lightColor * NL ) + g_ambientColor; 
	return float4(finalColor, 1);
}